name: Deploy to AWS Lambda

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'template.yaml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGION: us-west-1
  ECR_REPO: core
  IMAGE_NAME: commonforms
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # for OIDC
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.REGION }}
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: commonforms-service-deploy

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image
        shell: bash
        run: |
          set -euo pipefail
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_NAME}-${IMAGE_TAG}"
          echo "IMAGE_URI=$IMAGE_URI" >> "$GITHUB_ENV"

          echo "Building Docker image ${IMAGE_NAME}:${IMAGE_TAG}..."
          docker build --platform linux/amd64 -t "${IMAGE_NAME}:${IMAGE_TAG}" .

          echo "Tagging image as $IMAGE_URI..."
          docker tag "${IMAGE_NAME}:${IMAGE_TAG}" "$IMAGE_URI"

          echo "Pushing image to ECR..."
          docker push "$IMAGE_URI"

      - name: Update Lambda function
        shell: bash
        run: |
          set -euo pipefail
          : "${IMAGE_URI:?IMAGE_URI not set}"
          aws lambda update-function-code \
            --function-name commonforms \
            --image-uri "$IMAGE_URI" \
            --region "$REGION"
